@model WMS.Models.WarehouseTransactionModel

@{
    ViewData["Title"] = "Chỉnh sửa phiếu xuất kho";
}

<div class="container mt-4">
    <!-- 🧭 Tiêu đề & nút quay lại -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary">
            <i class="fa-solid fa-pen-to-square me-2"></i> Chỉnh sửa phiếu xuất kho
        </h2>
        <a asp-area="Admin" asp-controller="Warehouse" asp-action="ExportIndex"
           class="btn btn-outline-primary shadow-sm">
            <i class="fa fa-list"></i> Danh sách xuất kho
        </a>
    </div>

    <!-- 🗂 Form chỉnh sửa -->
    <div class="card shadow-lg border-0 rounded-4">
        <div class="card-body p-4">
            <form asp-area="Admin" asp-controller="Warehouse" asp-action="ExportEdit" method="POST">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="Id" />
                <input type="hidden" asp-for="TransactionType" />

                <!-- Hiển thị lỗi chung từ ModelState -->
                <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-3"></div>

                <!-- Sản phẩm -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold text-primary">Sản phẩm</label>
                        <!-- Sản phẩm không được chỉnh sửa sau khi tạo, nhưng phải gửi ID -->
                        <select asp-for="ProductId" id="ProductId" class="form-select shadow-sm" disabled>
                            @{
                                var productList = ViewBag.Products as List<SelectListItem>;
                                if (productList != null)
                                {
                                    foreach (var item in productList)
                                    {
                                        if (item.Value == Model.ProductId.ToString())
                                        {
                                            <option value="@item.Value" selected>@item.Text</option>
                                        }
                                        else
                                        {
                                            <option value="@item.Value">@item.Text</option>
                                        }
                                    }
                                }
                            }
                        </select>
                        <!-- Thêm input ẩn để đảm bảo ProductId được gửi lên Controller -->
                        <input type="hidden" asp-for="ProductId" value="@Model.ProductId" />
                        <div id="stockInfo" class="mt-2 small text-muted"></div> <!-- 🏭 Hiển thị tồn kho -->
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold text-primary">Đơn vị</label>
                        <input asp-for="Unit" id="Unit" class="form-control shadow-sm bg-light" readonly />
                    </div>
                </div>

                <!-- Số lượng - Đơn giá - Thành tiền -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold text-primary">Số lượng xuất</label>
                        <input asp-for="Quantity" id="Quantity" class="form-control shadow-sm" placeholder="Nhập số lượng xuất..." />

                        <!-- Hiển thị lỗi validation riêng cho Quantity -->
                        <span asp-validation-for="Quantity" class="text-danger small mt-1 d-block"></span>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-semibold text-primary">Đơn giá (VNĐ)</label>
                        <input asp-for="UnitPrice" id="UnitPrice" class="form-control shadow-sm" placeholder="Nhập đơn giá..." />
                        <span asp-validation-for="UnitPrice" class="text-danger"></span>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-semibold text-primary">Thành tiền (VNĐ)</label>
                        <input id="TotalValue" class="form-control shadow-sm bg-light fw-bold text-success" readonly />
                    </div>
                </div>

                <!-- Ghi chú -->
                <div class="mb-3">
                    <label class="form-label fw-semibold text-primary">Ghi chú</label>
                    <input asp-for="Notes" class="form-control shadow-sm" placeholder="Ghi chú thêm (nếu có)..." />
                </div>

                <button type="submit" class="btn btn-primary w-100 py-2 fw-semibold shadow">
                    <i class="fa-solid fa-floppy-disk me-2"></i> Cập nhật phiếu xuất kho
                </button>
            </form>
        </div>
    </div>
</div>

@section Styles {
    <style>
        body {
            background-color: #f8fafc;
        }

        .card {
            border-radius: 1rem;
        }

        .form-label {
            font-size: 0.95rem;
        }

        .form-control, .form-select {
            border-radius: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(90deg, #007bff, #0056b3);
            border: none;
        }

            .btn-primary:hover {
                background: linear-gradient(90deg, #0056b3, #004494);
            }

        /* CSS cho thông tin tồn kho */
        #stockInfo {
            font-size: 0.9rem;
        }
    </style>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        var currentStock = 0; // Biến global lưu tồn kho thực tế

        // ⚙️ Hàm lấy tồn kho và giá từ server
        function loadStockAndPrice(productId) {
            const stockInfo = $("#stockInfo");
            stockInfo.empty().html('<i class="fa-solid fa-spinner fa-spin me-1"></i> Đang tải tồn kho...');

            if (!productId) return;

            // API GetInventoryStock đã có trong WarehouseController
            fetch(`/Admin/Warehouse/GetInventoryStock?id=${productId}`)
                .then(res => res.json())
                .then(res => {
                    if (res.success) {
                        currentStock = res.stock || 0;
                        $("#Unit").val(res.unit || "");

                        // Hiển thị tồn kho
                        stockInfo.html(
                            "🏭 Tồn kho thực tế: <b class='text-success'>" + currentStock.toLocaleString('vi-VN') + " " + res.unit + "</b>"
                        );

                        updateTotal(); // Cập nhật tổng tiền và kiểm tra cảnh báo
                    } else {
                        stockInfo.html("<span class='text-danger'>Không tìm thấy dữ liệu tồn kho!</span>");
                        currentStock = 0;
                        updateTotal();
                    }
                })
                .catch(err => {
                    stockInfo.html("<span class='text-danger'>Lỗi khi truy vấn tồn kho!</span>");
                    console.error('Lỗi khi lấy tồn kho:', err);
                });
        }

        // ⚠️ Kiểm tra và hiển thị cảnh báo (Chỉ cảnh báo trên client)
        function checkClientWarning() {
            const quantityInput = $("#Quantity");
            const quantitySpan = $('span[asp-validation-for="Quantity"]');
            var qty = parseFloat(quantityInput.val()) || 0;

            // Xóa mọi cảnh báo cũ của client-side
            quantityInput.removeClass('is-invalid');
            quantitySpan.empty();

            if (qty > currentStock) {
                // Cảnh báo ngay trên input
                quantityInput.addClass('is-invalid');
                quantitySpan.html('<i class="fa-solid fa-triangle-exclamation"></i> Số lượng vượt quá tồn kho (' + currentStock.toLocaleString('vi-VN') + ')!');

            }
        }

        // 💰 Tính thành tiền tự động
        function updateTotal() {
            var qty = parseFloat($("#Quantity").val()) || 0;
            var price = parseFloat($("#UnitPrice").val()) || 0;
            $("#TotalValue").val((qty * price).toLocaleString('vi-VN'));

            checkClientWarning(); // Kiểm tra cảnh báo client sau khi nhập số lượng
        }

        $(document).ready(function () {
            // Lấy ID sản phẩm hiện tại (được chọn từ Controller)
            const initialProductId = '@Model.ProductId';

            if (initialProductId) {
                loadStockAndPrice(initialProductId);
            }

            // Cập nhật khi thay đổi số lượng hoặc đơn giá
            $("#Quantity, #UnitPrice").on("input", updateTotal);

            // Cập nhật tổng tiền lần đầu khi trang load
            updateTotal();
        });
    </script>
}
